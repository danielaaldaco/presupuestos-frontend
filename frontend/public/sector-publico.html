<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de México - Sector Público</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    html, body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
    .folder-btn {
      display: block;
      background-color: #f2f2f2;
      border: 1px solid #ccc;
      margin: 5px 0;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .folder-btn:hover { background-color: #d0e0ff; }

    /* Cards de resumen */
    .cards { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 10px; margin: 10px 0; }
    .card {
      background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.04);
    }
    .card h4 { margin: 0 0 6px 0; font-size: 14px; color: #555; }
    .card .val { font-weight: 700; font-size: 16px; }

    /* Tabla de partidas */
    .table-wrap { overflow:auto; border:1px solid #eee; border-radius: 8px; }
    table { width:100%; border-collapse: collapse; min-width: 720px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 1; }
    .num { text-align: right; white-space: nowrap; }
    .chip {
      display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600;
    }
    .chip-pos { background:#e8f5e9; color:#1b5e20; }
    .chip-neg { background:#ffebee; color:#b71c1c; }
    .small-muted { color:#777; font-size: 13px; }

    /* Listas */
    .list { margin: 8px 0; padding-left: 18px; }
    .list li { margin: 4px 0; }

    /* Panel lateral */
    .map-info pre {
      background:#f8f8f8; padding:10px; border-radius:6px; max-height:50vh; overflow:auto;
    }
  </style>
</head>
<body class="private-body">

  <header class="navbar">
    <div class="logo">Papus <span>por México</span></div>
    <nav class="nav-links">
      <a href="index.html">Inicio</a>
      <a href="index.html#sobre-nosotros">Sobre Nosotros</a>
      <a href="sector-publico.html">Sector Público</a>
      <a href="sector-privado.html" class="active">Sector Privado</a>
      <a href="index.html#contacto">Contacto</a>
    </nav>
  </header>

  <section class="map-page">
    <div class="map-wrap">
      <div id="map"></div>
      <div class="map-side">
        <h2>Datos del Estado / Ciudad</h2>
        <div class="map-info">
          <p>Haz clic en un estado para ver sus ciudades.</p>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <p>© 2025 TransparenciaMX — Todos los derechos reservados.</p>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ==================== CONFIG ====================
    const API_BASE = "http://127.0.0.1:8000/api"; // ajusta si tu backend usa otra IP/puerto
    const mxn = new Intl.NumberFormat('es-MX',{ style:'currency', currency:'MXN' });
    const pct = (v) => (v ?? 0).toLocaleString('es-MX', { maximumFractionDigits: 2 }) + ' %';
    const fmt = (v) => (typeof v === 'number' ? v.toLocaleString('es-MX', { maximumFractionDigits: 2 }) : v);

    // ==================== MAPA ====================
    const map = L.map('map').setView([23.6345, -102.5528], 5);
    const capaCiudades = L.layerGroup().addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // ==================== COLORES ====================
    function darkenColor(hex, percent) {
      var f = parseInt(hex.slice(1),16),
          t = percent < 0 ? 0 : 255,
          p = percent < 0 ? percent * -1 : percent,
          R = f >> 16, G = (f >> 8) & 0x00ff, B = f & 0x0000ff;
      return "#" + (0x1000000 + (Math.round((t-R)*p)+R)*0x10000
        + (Math.round((t-G)*p)+G)*0x100
        + (Math.round((t-B)*p)+B)).toString(16).slice(1);
    }
    function getRandomColorAndBorder() {
      const colors = ['#4CAF50','#FFD700','#F44336'];
      const base = colors[Math.floor(Math.random()*colors.length)];
      return { fillColor: base, color: darkenColor(base,-0.2), weight: 2, fillOpacity: 0.9 };
    }

    // ==================== CARGAR ESTADOS ====================
    fetch('estados_mexico.geojson')
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: getRandomColorAndBorder,
          onEachFeature: (feature, layer) => {
            const nombre = feature.properties.name || "Sin nombre";
            const center = layer.getBounds().getCenter();
            const labelIcon = L.divIcon({
              className: 'state-label-icon',
              html: nombre,
              iconSize: [120,20],
              iconAnchor: [60,10]
            });
            L.marker(center, { icon: labelIcon, interactive:false }).addTo(map);
            layer.on('click', () => {
              map.fitBounds(layer.getBounds());
              cargarCiudades(nombre);
            });
          }
        }).addTo(map);
      })
      .catch(err => alert("Error al cargar estados: " + err));

    // ==================== CARGAR CIUDADES ====================
    function cargarCiudades(estado) {
      capaCiudades.clearLayers();
      const archivos = {
        "Coahuila": "ciudades_coahuila.geojson",
        "Nuevo León": "ciudades_nuevoleon.geojson",
        "Chihuahua": "ciudades_chihuahua.geojson",
        "Jalisco": "ciudades_jalisco.geojson",
        "Sinaloa": "ciudades_sinaloa.geojson",
        "Sonora": "ciudades_sonora.geojson",
        "Durango": "ciudades_durango.geojson",
        "Baja California": "ciudades_bajacalifornia.geojson",
        "Baja California Sur": "ciudades_bajacaliforniasur.geojson",
        "Zacatecas": "ciudades_zacatecas.geojson",
        "Aguascalientes": "ciudades_aguascalientes.geojson",
        "Guanajuato": "ciudades_guanajuato.geojson",
        "Querétaro": "ciudades_queretaro.geojson",
        "Michoacán": "ciudades_michoacan.geojson",
        "Colima": "ciudades_colima.geojson",
        "Nayarit": "ciudades_nayarit.geojson",
        "Tlaxcala": "ciudades_tlaxcala.geojson",
        "Yucatán": "ciudades_yucatan.geojson",
        "Campeche": "ciudades_campeche.geojson",
        "Quintana Roo": "ciudades_quintanaroo.geojson",
        "Oaxaca": "ciudades_oaxaca.geojson",
        "Chiapas": "ciudades_chiapas.geojson",
        "Veracruz": "ciudades_veracruz.geojson",
        "Morelos": "ciudades_morelos.geojson",
        "Puebla": "ciudades_puebla.geojson",
        "cdmx": "ciudades_cdmx.geojson",
        "Estado de México": "ciudades_mexico.geojson",
        "Tamaulipas": "ciudades_tamaulipas.geojson",
        "Tabasco": "ciudades_tabasco.geojson",
        "San Luis Potosí": "ciudades_sanluis.geojson"
      };

      const archivo = archivos[estado];
      if (!archivo) return;

      fetch(archivo)
        .then(res => res.json())
        .then(data => {
          L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
              const ciudad = feature.properties.name || "Ciudad";
              return L.circleMarker(latlng, {
                radius: 6, fillColor: "#3388ff", color: "#000",
                weight: 1, opacity: 1, fillOpacity: 0.8
              })
              .bindTooltip(ciudad)
              .on('click', () => seleccionarCiudad(estado, ciudad));
            }
          }).addTo(capaCiudades);
        })
        .catch(err => alert("Error al cargar ciudades: " + err));
    }

    // ==================== UI HELPERS ====================
    function setInfoHTML(html) {
      const box = document.querySelector('.map-info');
      if (box) box.innerHTML = html;
    }
    function appendInfoHTML(html) {
      const box = document.querySelector('.map-info');
      if (box) box.innerHTML += html;
    }

    // ==================== RENDER JSON DE ANÁLISIS ====================
    function renderResumen(resumen) {
      const c = resumen || {};
      return `
        <div class="cards">
          <div class="card">
            <h4>Costo en contrato</h4>
            <div class="val">${mxn.format(c.costo_en_contrato ?? 0)}</div>
          </div>
          <div class="card">
            <h4>Precio estimado mercado</h4>
            <div class="val">${mxn.format(c.precio_estimado_mercado ?? 0)}</div>
          </div>
          <div class="card">
            <h4>Diferencia total</h4>
            <div class="val">${mxn.format(c.diferencia_total ?? 0)}</div>
          </div>
          <div class="card">
            <h4>Diferencia %</h4>
            <div class="val">${(c.diferencia_porcentaje ?? 0).toLocaleString('es-MX',{maximumFractionDigits:2})}%</div>
          </div>
          <div class="card">
            <h4>Credibilidad</h4>
            <div class="val">${fmt(c.credibilidad)} / 100</div>
          </div>
        </div>
      `;
    }

    function renderPartidas(partidas = []) {
      if (!Array.isArray(partidas) || partidas.length === 0) {
        return `<p class="small-muted">Sin partidas.</p>`;
      }
      const rows = partidas.map(p => {
        const dif = p.diferencia ?? 0;
        const chip = dif >= 0
          ? `<span class="chip chip-pos">+${mxn.format(dif)}</span>`
          : `<span class="chip chip-neg">${mxn.format(dif)}</span>`;
        const difp = p["diferencia_%"];
        const difpTxt = (typeof difp === 'number')
          ? (difp >= 0 ? `+${difp.toFixed(2)}%` : `${difp.toFixed(2)}%`)
          : '-';
        return `
          <tr>
            <td>${p.concepto ?? '-'}</td>
            <td>${p.unidad ?? '-'}</td>
            <td class="num">${fmt(p.cantidad)}</td>
            <td class="num">${mxn.format(p.costo_en_contrato ?? 0)}</td>
            <td class="num">${mxn.format(p.precio_estimado_mercado ?? 0)}</td>
            <td class="num">${chip}</td>
            <td class="num">${difpTxt}</td>
          </tr>
        `;
      }).join('');
      return `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Unidad</th>
                <th>Cantidad</th>
                <th>Costo contrato</th>
                <th>Precio mercado</th>
                <th>Diferencia</th>
                <th>Diferencia %</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function renderList(title, items = []) {
      if (!Array.isArray(items) || items.length === 0) return '';
      const li = items.map(x => `<li>${x}</li>`).join('');
      return `<h3>${title}</h3><ul class="list">${li}</ul>`;
    }

    // ==================== AL SELECCIONAR UNA CIUDAD ====================
    async function seleccionarCiudad(estado, ciudad) {
      setInfoHTML(`
        <p><strong>Estado:</strong> ${estado}</p>
        <p><strong>Ciudad:</strong> ${ciudad}</p>
        <p style="font-weight:bold;">📍 Ruta: ${estado} / ${ciudad}</p>
        <p>🔍 Cargando carpetas desde el servidor...</p>
      `);
      console.log(`📍 Ruta: ${estado} / ${ciudad}`);

      try {
        const url = `${API_BASE}/listar/${encodeURIComponent(estado)}/${encodeURIComponent(ciudad)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();

        if (!data.carpetas?.length) {
          appendInfoHTML(`<p>No hay carpetas disponibles.</p>`);
          return;
        }

        let html = `<h3>📁 Carpetas disponibles:</h3>`;
        data.carpetas.forEach(folder => {
          const fEnc = encodeURIComponent(folder);
          html += `<button class="folder-btn" onclick="analizarCarpeta('${encodeURIComponent(estado)}','${encodeURIComponent(ciudad)}','${fEnc}')">${folder}</button>`;
        });

        appendInfoHTML(html);
      } catch (err) {
        appendInfoHTML(`<p style="color:red;">Error al listar: ${err}</p>`);
      }
    }

    // ==================== ANALIZAR CARPETA (PARSEA JSON) ====================
    async function analizarCarpeta(estadoEnc, ciudadEnc, carpetaEnc) {
      const estado = decodeURIComponent(estadoEnc);
      const ciudad = decodeURIComponent(ciudadEnc);
      const carpeta = decodeURIComponent(carpetaEnc);

      setInfoHTML(`
        <p><strong>Analizando:</strong> ${estado} / ${ciudad} / ${carpeta}</p>
        <p>🧠 Analizando costos... por favor espera.</p>
      `);

      try {
        const url = `${API_BASE}/analizar/${estadoEnc}/${ciudadEnc}/${carpetaEnc}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();

        // Estructura esperada
        // data = { ruta, estado: "ok", resultado: { resumen_general, partidas, alertas, recomendaciones } }
        const resultado = data?.resultado || {};
        const resumen = resultado?.resumen_general || {};
        const partidas = resultado?.partidas || [];
        const alertas = resultado?.alertas || [];
        const recomendaciones = resultado?.recomendaciones || [];

        const html = `
          <h3>✅ Análisis completado</h3>
          <p><strong>Ruta:</strong> ${estado} / ${ciudad} / ${carpeta}</p>

          ${renderResumen(resumen)}

          <h3>📦 Partidas</h3>
          ${renderPartidas(partidas)}

          ${renderList('⚠️ Alertas', alertas)}
          ${renderList('🛠 Recomendaciones', recomendaciones)}
        `;
        setInfoHTML(html);
      } catch (err) {
        appendInfoHTML(`<p style="color:red;">Error al analizar: ${err}</p>`);
      }
    }

    // Exponer para que funcione el onclick de los botones
    window.analizarCarpeta = analizarCarpeta;
  </script>
</body>
</html>
